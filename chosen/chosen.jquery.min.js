/*
Chosen, a Select Box Enhancer for jQuery and Protoype
by Patrick Filler for Harvest, http://getharvest.com

Available for use under the MIT License, http://en.wikipedia.org/wiki/MIT_License

Copyright (c) 2011 by Harvest
*/
(function(){var e,f,c,d,a;var b=function(g,h){return function(){return g.apply(h,arguments);};};a=typeof exports!=="undefined"&&exports!==null?exports:this;e=jQuery;e.fn.extend({chosen:function(h,g){return e(this).each(function(i){if(!(e(this)).hasClass("chzn-done")){return new f(this,h,g);}});}});f=(function(){function g(h){this.set_default_values();this.form_field=h;this.form_field_jq=e(this.form_field);this.is_multiple=this.form_field.multiple;this.default_text_default=this.form_field.multiple?"Select Some Options":"Select an Option";this.set_up_html();this.register_observers();this.form_field_jq.addClass("chzn-done");}g.prototype.set_default_values=function(){this.click_test_action=b(function(h){return this.test_active_click(h);},this);this.active_field=false;this.mouse_on_container=false;this.results_showing=false;this.result_highlighted=null;this.result_single_selected=null;return this.choices=0;};g.prototype.set_up_html=function(){var l,k,j,i;this.container_id=this.form_field.id.replace(".","_")+"_chzn";var h=h=this.form_field_jq.width();e(e(this.form_field).children()).each(function(){var m=e(this).width();h=h>m?h:m;});h+=25;this.f_width=h;this.default_text=this.form_field_jq.attr("title")?this.form_field_jq.attr("title"):this.default_text_default;l=e("<div />",{id:this.container_id,"class":"chzn-container",style:"width: "+this.f_width+"px;"});if(this.is_multiple){l.html('<ul class="chzn-choices"><li class="search-field"><input type="text" value="'+this.default_text+'" class="default" style="width:25px;" /></li></ul><div class="chzn-drop" style="left:-9000px;"><ul class="chzn-results"></ul></div>');}else{l.html('<a href="javascript:void(0)" class="chzn-single"><span>'+this.default_text+'</span><div><b></b></div></a><div class="chzn-drop" style="left:-9000px;"><div class="chzn-search"><input type="text" /></div><ul class="chzn-results"></ul></div>');}this.form_field_jq.hide().after(l);this.container=e("#"+this.container_id);this.container.addClass("chzn-container-"+(this.is_multiple?"multi":"single"));this.dropdown=this.container.find("div.chzn-drop").first();k=this.container.height();j=this.f_width-d(this.dropdown);this.dropdown.css({width:j+"px",top:k+"px"});this.search_field=this.container.find("input").first();this.search_results=this.container.find("ul.chzn-results").first();this.search_field_scale();this.search_no_results=this.container.find("li.no-results").first();if(this.is_multiple){this.search_choices=this.container.find("ul.chzn-choices").first();this.search_container=this.container.find("li.search-field").first();}else{this.search_container=this.container.find("div.chzn-search").first();this.selected_item=this.container.find(".chzn-single").first();i=j-d(this.search_container)-d(this.search_field);this.search_field.css({width:i+"px"});}this.results_build();return this.set_tab_index();};g.prototype.register_observers=function(){this.container.click(b(function(h){return this.container_click(h);},this));this.container.mouseenter(b(function(h){return this.mouse_enter(h);},this));this.container.mouseleave(b(function(h){return this.mouse_leave(h);},this));this.search_results.click(b(function(h){return this.search_results_click(h);},this));this.search_results.mouseover(b(function(h){return this.search_results_mouseover(h);},this));this.search_results.mouseout(b(function(h){return this.search_results_mouseout(h);},this));this.form_field_jq.bind("liszt:updated",b(function(h){return this.results_update_field(h);},this));this.search_field.blur(b(function(h){return this.input_blur(h);},this));this.search_field.keyup(b(function(h){return this.keyup_checker(h);},this));this.search_field.keydown(b(function(h){return this.keydown_checker(h);},this));if(this.is_multiple){this.search_choices.click(b(function(h){return this.choices_click(h);},this));return this.search_field.focus(b(function(h){return this.input_focus(h);},this));}else{return this.selected_item.focus(b(function(h){return this.activate_field(h);},this));}};g.prototype.container_click=function(h){if(h&&h.type==="click"){h.stopPropagation();}if(!this.pending_destroy_click){if(!this.active_field){if(this.is_multiple){this.search_field.val("");}e(document).click(this.click_test_action);this.results_show();}else{if(!this.is_multiple&&h&&(e(h.target)===this.selected_item||e(h.target).parents("a.chzn-single").length)){h.preventDefault();this.results_toggle();}}return this.activate_field();}else{return this.pending_destroy_click=false;}};g.prototype.mouse_enter=function(){return this.mouse_on_container=true;};g.prototype.mouse_leave=function(){return this.mouse_on_container=false;};g.prototype.input_focus=function(h){if(!this.active_field){return setTimeout((b(function(){return this.container_click();},this)),50);}};g.prototype.input_blur=function(h){if(!this.mouse_on_container){this.active_field=false;return setTimeout((b(function(){return this.blur_test();},this)),100);}};g.prototype.blur_test=function(h){if(!this.active_field&&this.container.hasClass("chzn-container-active")){return this.close_field();}};g.prototype.close_field=function(){e(document).unbind("click",this.click_test_action);if(!this.is_multiple){this.selected_item.attr("tabindex",this.search_field.attr("tabindex"));this.search_field.attr("tabindex",-1);}this.active_field=false;this.results_hide();this.container.removeClass("chzn-container-active");this.winnow_results_clear();this.clear_backstroke();this.show_search_field_default();return this.search_field_scale();};g.prototype.activate_field=function(){if(!this.is_multiple&&!this.active_field){this.search_field.attr("tabindex",this.selected_item.attr("tabindex"));this.selected_item.attr("tabindex",-1);}this.container.addClass("chzn-container-active");this.active_field=true;this.search_field.val(this.search_field.val());return this.search_field.focus();};g.prototype.test_active_click=function(h){if(e(h.target).parents("#"+this.container.id).length){return this.active_field=true;}else{return this.close_field();}};g.prototype.results_build=function(){var j,m,i,l,h,k;i=new Date();this.parsing=true;this.results_data=c.select_to_array(this.form_field);if(this.is_multiple&&this.choices>0){this.search_choices.find("li.search-choice").remove();this.choices=0;}else{if(!this.is_multiple){this.selected_item.find("span").text(this.default_text);}}j="";k=this.results_data;for(l=0,h=k.length;l<h;l++){m=k[l];if(m.group){j+=this.result_add_group(m);}else{if(!m.empty){j+=this.result_add_option(m);if(m.selected&&this.is_multiple){this.choice_build(m);}else{if(m.selected&&!this.is_multiple){this.selected_item.find("span").text(m.text);}}}}}this.show_search_field_default();this.search_field_scale();this.search_results.html(j);return this.parsing=false;};g.prototype.result_add_group=function(h){if(!h.disabled){h.dom_id=this.form_field.id.replace(".","_")+"chzn_g_"+h.array_index;return'<li id="'+h.dom_id+'" class="group-result">'+e("<div />").text(h.label).html()+"</li>";}else{return"";}};g.prototype.result_add_option=function(i){var h;if(!i.disabled){i.dom_id=this.form_field.id.replace(".","_")+"chzn_o_"+i.array_index;h=i.selected&&this.is_multiple?[]:["active-result"];if(i.selected){h.push("result-selected");}if(i.group_array_index!=null){h.push("group-option");}return'<li id="'+i.dom_id+'" class="'+h.join(" ")+'">'+e("<div />").text(i.text).html()+"</li>";}else{return"";}};g.prototype.results_update_field=function(){this.result_clear_highlight();this.result_single_selected=null;return this.results_build();};g.prototype.result_do_highlight=function(i){var m,l,j,k,h;if(i.length){this.result_clear_highlight();this.result_highlight=i;this.result_highlight.addClass("highlighted");j=parseInt(this.search_results.css("maxHeight"),10);h=this.search_results.scrollTop();k=j+h;l=this.result_highlight.position().top+this.search_results.scrollTop();m=l+this.result_highlight.outerHeight();if(m>=k){return this.search_results.scrollTop((m-j)>0?m-j:0);}else{if(l<h){return this.search_results.scrollTop(l);}}}};g.prototype.result_clear_highlight=function(){if(this.result_highlight){this.result_highlight.removeClass("highlighted");}return this.result_highlight=null;};g.prototype.results_toggle=function(){if(this.results_showing){return this.results_hide();}else{return this.results_show();}};g.prototype.results_show=function(){var h;if(!this.is_multiple){this.selected_item.addClass("chzn-single-with-drop");if(this.result_single_selected){this.result_do_highlight(this.result_single_selected);}}h=this.is_multiple?this.container.height():this.container.height()-1;this.dropdown.css({top:h+"px",left:0});this.results_showing=true;this.search_field.focus();this.search_field.val(this.search_field.val());return this.winnow_results();};g.prototype.results_hide=function(){if(!this.is_multiple){this.selected_item.removeClass("chzn-single-with-drop");}this.result_clear_highlight();this.dropdown.css({left:"-9000px"});return this.results_showing=false;};g.prototype.set_tab_index=function(i){var h;if(this.form_field_jq.attr("tabindex")){h=this.form_field_jq.attr("tabindex");this.form_field_jq.attr("tabindex",-1);if(this.is_multiple){return this.search_field.attr("tabindex",h);}else{this.selected_item.attr("tabindex",h);return this.search_field.attr("tabindex",-1);}}};g.prototype.show_search_field_default=function(){if(this.is_multiple&&this.choices<1&&!this.active_field){this.search_field.val(this.default_text);return this.search_field.addClass("default");}else{this.search_field.val("");return this.search_field.removeClass("default");}};g.prototype.search_results_click=function(h){var i;i=e(h.target).hasClass("active-result")?e(h.target):e(h.target).parents(".active-result").first();if(i.length){this.result_highlight=i;return this.result_select();}};g.prototype.search_results_mouseover=function(h){var i;i=e(h.target).hasClass("active-result")?e(h.target):e(h.target).parents(".active-result").first();if(i){return this.result_do_highlight(i);}};g.prototype.search_results_mouseout=function(h){if(e(h.target).hasClass("active-result"||e(h.target).parents(".active-result").first())){return this.result_clear_highlight();}};g.prototype.choices_click=function(h){h.preventDefault();if(this.active_field&&!(e(h.target).hasClass("search-choice"||e(h.target).parents(".search-choice").first))&&!this.results_showing){return this.results_show();}};g.prototype.choice_build=function(j){var h,i;h=this.form_field.id.replace(".","_")+"_chzn_c_"+j.array_index;this.choices+=1;this.search_container.before('<li class="search-choice" id="'+h+'"><span>'+j.text+'</span><a href="javascript:void(0)" class="search-choice-close" rel="'+j.array_index+'"></a></li>');i=e("#"+h).find("a").first();return i.click(b(function(k){return this.choice_destroy_link_click(k);},this));};g.prototype.choice_destroy_link_click=function(h){h.preventDefault();this.pending_destroy_click=true;return this.choice_destroy(e(h.target));};g.prototype.choice_destroy=function(h){this.choices-=1;this.show_search_field_default();if(this.is_multiple&&this.choices>0&&this.search_field.val().length<1){this.results_hide();}this.result_deselect(h.attr("rel"));return h.parents("li").first().remove();};g.prototype.result_select=function(){var k,j,i,h;if(this.result_highlight){k=this.result_highlight;j=k.attr("id");this.result_clear_highlight();k.addClass("result-selected");if(this.is_multiple){this.result_deactivate(k);}else{this.result_single_selected=k;}h=j.substr(j.lastIndexOf("_")+1);i=this.results_data[h];i.selected=true;this.form_field.options[i.options_index].selected=true;if(this.is_multiple){this.choice_build(i);}else{this.selected_item.find("span").first().text(i.text);}this.results_hide();this.search_field.val("");this.form_field_jq.trigger("change");return this.search_field_scale();}};g.prototype.result_activate=function(h){return h.addClass("active-result").show();};g.prototype.result_deactivate=function(h){return h.removeClass("active-result").hide();};g.prototype.result_deselect=function(j){var h,i;i=this.results_data[j];i.selected=false;this.form_field.options[i.options_index].selected=false;h=e("#"+this.form_field.id.replace(".","_")+"chzn_o_"+j);h.removeClass("result-selected").addClass("active-result").show();this.result_clear_highlight();this.winnow_results();this.form_field_jq.trigger("change");return this.search_field_scale();};g.prototype.results_search=function(h){if(this.results_showing){return this.winnow_results();}else{return this.results_show();}};g.prototype.winnow_results=function(){var x,q,k,n,u,s,p,w,j,r,v,i,m,l,t,h,o;j=new Date();this.no_results_clear();p=0;w=this.search_field.val()===this.default_text?"":e.trim(this.search_field.val());u=new RegExp("^"+w.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i");i=new RegExp(w.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i");o=this.results_data;for(m=0,t=o.length;m<t;m++){q=o[m];if(!q.disabled&&!q.empty){if(q.group){e("#"+q.dom_id).hide();}else{if(!(this.is_multiple&&q.selected)){x=false;s=q.dom_id;if(u.test(q.text)){x=true;p+=1;}else{if(q.text.indexOf(" ")>=0||q.text.indexOf("[")===0){n=q.text.replace(/\[|\]/g,"").split(" ");if(n.length){for(l=0,h=n.length;l<h;l++){k=n[l];if(u.test(k)){x=true;p+=1;}}}}}if(x){if(w.length){r=q.text.search(i);v=q.text.substr(0,r+w.length)+"</em>"+q.text.substr(r+w.length);v=v.substr(0,r)+"<em>"+v.substr(r);}else{v=q.text;}if(e("#"+s).html!==v){e("#"+s).html(v);}this.result_activate(e("#"+s));if(q.group_array_index!=null){e("#"+this.results_data[q.group_array_index].dom_id).show();}}else{if(this.result_highlight&&s===this.result_highlight.attr("id")){this.result_clear_highlight();}this.result_deactivate(e("#"+s));}}}}}if(p<1&&w.length){return this.no_results(w);}else{return this.winnow_results_set_highlight();}};g.prototype.winnow_results_clear=function(){var h,k,l,j,i;this.search_field.val("");k=this.search_results.find("li");i=[];for(l=0,j=k.length;l<j;l++){h=k[l];h=e(h);i.push(h.hasClass("group-result")?h.show():!this.is_multiple||!h.hasClass("result-selected")?this.result_activate(h):void 0);}return i;};g.prototype.winnow_results_set_highlight=function(){var h;if(!this.result_highlight){h=this.search_results.find(".active-result").first();if(h){return this.result_do_highlight(h);}}};g.prototype.no_results=function(h){var i;i=e('<li class="no-results">No results match "<span></span>"</li>');i.find("span").first().text(h);return this.search_results.append(i);};g.prototype.no_results_clear=function(){return this.search_results.find(".no-results").remove();};g.prototype.keydown_arrow=function(){var i,h;if(!this.result_highlight){i=this.search_results.find("li.active-result").first();if(i){this.result_do_highlight(e(i));}}else{if(this.results_showing){h=this.result_highlight.nextAll("li.active-result").first();if(h){this.result_do_highlight(h);}}}if(!this.results_showing){return this.results_show();}};g.prototype.keyup_arrow=function(){var h;if(!this.results_showing&&!this.is_multiple){return this.results_show();}else{if(this.result_highlight){h=this.result_highlight.prevAll("li.active-result");if(h.length){return this.result_do_highlight(h.first());}else{if(this.choices>0){this.results_hide();}return this.result_clear_highlight();}}}};g.prototype.keydown_backstroke=function(){if(this.pending_backstroke){this.choice_destroy(this.pending_backstroke.find("a").first());return this.clear_backstroke();}else{this.pending_backstroke=this.search_container.siblings("li.search-choice").last();return this.pending_backstroke.addClass("search-choice-focus");}};g.prototype.clear_backstroke=function(){if(this.pending_backstroke){this.pending_backstroke.removeClass("search-choice-focus");}return this.pending_backstroke=null;};g.prototype.keyup_checker=function(h){var j,i;j=(i=h.which)!=null?i:h.keyCode;this.search_field_scale();switch(j){case 8:if(this.is_multiple&&this.backstroke_length<1&&this.choices>0){return this.keydown_backstroke();}else{if(!this.pending_backstroke){this.result_clear_highlight();return this.results_search();}}break;case 13:h.preventDefault();if(this.results_showing){return this.result_select();}break;case 27:if(this.results_showing){return this.results_hide();}break;case 9:case 38:case 40:case 16:break;default:return this.results_search();}};g.prototype.keydown_checker=function(h){var j,i;j=(i=h.which)!=null?i:h.keyCode;this.search_field_scale();if(j!==8&&this.pending_backstroke){this.clear_backstroke();}switch(j){case 8:this.backstroke_length=this.search_field.val().length;break;case 9:this.mouse_on_container=false;break;case 13:h.preventDefault();break;case 38:h.preventDefault();this.keyup_arrow();break;case 40:this.keydown_arrow();break;}};g.prototype.search_field_scale=function(){var q,i,l,j,o,p,n,k,m;if(this.is_multiple){l=0;n=0;o="position:absolute; left: -1000px; top: -1000px; display:none;";p=["font-size","font-style","font-weight","font-family","line-height","text-transform","letter-spacing"];for(k=0,m=p.length;k<m;k++){j=p[k];o+=j+":"+this.search_field.css(j)+";";}i=e("<div />",{style:o});i.text(this.search_field.val());e("body").append(i);n=i.width()+25;i.remove();if(n>this.f_width-10){n=this.f_width-10;}this.search_field.css({width:n+"px"});q=this.container.height();return this.dropdown.css({top:q+"px"});}};return g;})();d=function(g){var h;return h=g.outerWidth()-g.width();};a.get_side_border_padding=d;c=(function(){function g(){this.options_index=0;this.parsed=[];}g.prototype.add_node=function(h){if(h.nodeName==="OPTGROUP"){return this.add_group(h);}else{return this.add_option(h);}};g.prototype.add_group=function(n){var m,j,l,i,k,h;m=this.parsed.length;this.parsed.push({array_index:m,group:true,label:n.label,children:0,disabled:n.disabled});k=n.childNodes;h=[];for(l=0,i=k.length;l<i;l++){j=k[l];h.push(this.add_option(j,m,n.disabled));}return h;};g.prototype.add_option=function(i,j,h){if(i.nodeName==="OPTION"){if(i.text!==""){if(j!=null){this.parsed[j].children+=1;}this.parsed.push({array_index:this.parsed.length,options_index:this.options_index,value:i.value,text:i.text,selected:i.selected,disabled:h===true?h:i.disabled,group_array_index:j});}else{this.parsed.push({array_index:this.parsed.length,options_index:this.options_index,empty:true});}return this.options_index+=1;}};return g;})();c.select_to_array=function(g){var l,k,j,h,i;k=new c();i=g.childNodes;for(j=0,h=i.length;j<h;j++){l=i[j];k.add_node(l);}return k.parsed;};a.SelectParser=c;}).call(this);
